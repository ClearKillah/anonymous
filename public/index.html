<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Anon Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="styles.css">
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
      -webkit-user-select: none;
      user-select: none;
      overscroll-behavior: none;
      height: 100vh;
      height: -webkit-fill-available;
      padding-top: env(safe-area-inset-top);
    }

    #mainWrapper {
      width: 100%;
      height: 100%;
      height: -webkit-fill-available;
      display: flex;
      flex-direction: column;
      padding-top: 0;
    }

    /* Profile Form */
    #profileForm {
      padding: 16px 16px calc(16px + env(safe-area-inset-bottom));
      background: var(--tg-theme-bg-color, #fff);
      animation: fadeIn 0.3s ease;
      padding-top: 0;
      height: 100%;
    }
    
    #profileForm h3 {
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: 600;
      color: var(--tg-theme-text-color, #000);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #profileForm h3::before {
      content: "üí≠";
      font-size: 24px;
    }
    
    .input-group {
      margin-bottom: 20px;
      animation: slideUp 0.3s ease;
      animation-fill-mode: both;
    }
    
    .input-group:nth-child(2) { animation-delay: 0.1s; }
    .input-group:nth-child(3) { animation-delay: 0.2s; }
    .input-group:nth-child(4) { animation-delay: 0.3s; }
    
    .label {
      font-size: 14px;
      color: var(--tg-theme-hint-color, #999);
      margin-bottom: 8px;
      display: block;
      font-weight: 500;
    }
    
    #profileForm input {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 4px;
      border: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
      border-radius: 10px;
      font-size: 16px;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      color: var(--tg-theme-text-color, #000);
      transition: all 0.2s ease;
    }

    #profileForm input:focus {
      border-color: var(--tg-theme-button-color, #2481cc);
      background: var(--tg-theme-bg-color, #fff);
      outline: none;
    }

    /* Gender Buttons */
    #genderButtons {
      display: flex;
      gap: 8px;
      margin-bottom: 4px;
    }
    
    .gender-btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
      font-size: 16px;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      color: var(--tg-theme-text-color, #000);
      transition: all 0.2s ease;
    }
    
    .gender-btn[data-value="m"] {
      background: rgba(0, 122, 255, 0.1);
      border-color: rgba(0, 122, 255, 0.2);
      color: #007AFF;
    }
    
    .gender-btn[data-value="f"] {
      background: rgba(255, 45, 85, 0.1);
      border-color: rgba(255, 45, 85, 0.2);
      color: #FF2D55;
    }
    
    .gender-btn[data-value="m"].active {
      background: #007AFF;
      border-color: #007AFF;
      color: #fff;
    }
    
    .gender-btn[data-value="f"].active {
      background: #FF2D55;
      border-color: #FF2D55;
      color: #fff;
    }

    /* Interests */
    #interestsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 4px;
    }
    
    .interest-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      color: var(--tg-theme-text-color, #000);
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .interest-btn.active {
      background: var(--tg-theme-button-color, #2481cc);
      border-color: var(--tg-theme-button-color, #2481cc);
      color: var(--tg-theme-button-text-color, #fff);
    }

    /* Main button */
    #saveProfileBtn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--tg-theme-button-color, #2481cc);
      color: var(--tg-theme-button-text-color, #fff);
      font-size: 16px;
      font-weight: 500;
      padding: 14px;
      border-radius: 10px;
      border: none;
    }

    /* Chat Container */
    #chatContainer {
      flex: 1;
      display: none;
      flex-direction: column;
      height: 100%;
      position: relative;
      overflow: hidden;
      padding-top: 0;
      height: 100%;
    }
    
    #partnerInfo {
      padding: 12px 16px;
      border-bottom: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--tg-theme-bg-color, #fff);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }
    
    #skipBtn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: var(--tg-theme-button-color, #2481cc);
      color: var(--tg-theme-button-text-color, #fff);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #skipBtn:active {
      transform: scale(0.95);
    }

    /* Chat Area */
    #chat {
      flex: 1;
      height: calc(100vh - 60px); /* –í—ã—Å–æ—Ç–∞ –º–∏–Ω—É—Å –ø–æ–ª–µ –≤–≤–æ–¥–∞ */
      padding: 16px;
      padding-bottom: calc(60px + env(safe-area-inset-bottom));
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      position: relative;
      background: var(--tg-theme-bg-color, #fff);
    }
    
    #chat::-webkit-scrollbar {
      width: 4px;
    }

    #chat::-webkit-scrollbar-track {
      background: transparent;
    }

    #chat::-webkit-scrollbar-thumb {
      background: var(--tg-theme-hint-color, rgba(0, 0, 0, 0.2));
      border-radius: 2px;
    }
    
    .system-message {
      text-align: center;
      color: var(--tg-theme-hint-color, #999);
      font-size: 14px;
      margin: 8px 0;
    }
    
    .chat-msg {
      opacity: 0;
      transform: translateY(10px);
      animation: slideUpFade 0.3s ease forwards;
    }
    
    .my-message,
    .partner-message {
      max-width: 80%;
      padding: 12px 16px;
      margin: 4px 0;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.4;
      position: relative;
      word-break: break-word;
      white-space: pre-wrap;
    }
    
    .my-message {
      margin-left: auto;
      border-bottom-right-radius: 4px;
      background: var(--tg-theme-button-color, #2481cc);
      color: var(--tg-theme-button-text-color, #fff);
    }
    
    .partner-message {
      margin-right: auto;
      border-bottom-left-radius: 4px;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      color: var(--tg-theme-text-color, #000);
    }

    /* Input Area */
    #inputArea {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      min-height: 48px;
      background: var(--tg-theme-bg-color, #fff);
      border-top: 1px solid var(--tg-theme-secondary-bg-color, rgba(0, 0, 0, 0.1));
      padding: 6px 8px;
      padding-bottom: calc(6px + env(safe-area-inset-bottom));
      display: flex;
      align-items: flex-end;
      gap: 8px;
      z-index: 1000;
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
    }
    
    #messageInput {
      flex: 1;
      min-height: 36px;
      max-height: 150px;
      padding: 8px 12px;
      border: none;
      border-radius: 18px;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      font-size: 16px;
      line-height: 20px;
      color: var(--tg-theme-text-color, #000);
      resize: none;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    #messageInput:focus {
      outline: none;
    }

    /* –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Å—Ç–∏–ª–µ Telegram */
    #sendBtn {
      width: 36px;
      height: 36px;
      padding: 0;
      border: none;
      border-radius: 50%;
      background: var(--tg-theme-button-color, #2481cc);
      color: var(--tg-theme-button-text-color, #fff);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-bottom: 0;
      transition: opacity 0.15s ease;
    }

    #sendBtn:active {
      opacity: 0.7;
    }

    /* iOS specific styles */
    @supports (-webkit-touch-callout: none) {
      #inputArea {
        position: fixed;
      }
    }

    /* Desktop styles */
    @media (min-width: 769px) {
      #chatContainer {
        padding-bottom: 0;
      }

      #chat {
        position: relative;
        top: 0;
        padding-bottom: 16px;
      }
      
      #inputArea {
        position: relative;
        padding: 12px;
        bottom: 0;
      }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideUpFade {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* –£–¥–∞–ª—è–µ–º ripple —ç—Ñ—Ñ–µ–∫—Ç */
    .ripple::after {
      display: none;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏—è */
    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
      text-align: right;
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–Ω–ª–∞–π–Ω–∞ */
    .online-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4CAF50;
      display: inline-block;
      margin-right: 6px;
    }

    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è placeholder */
    #messageInput::placeholder {
      color: var(--tg-theme-hint-color, #999);
      opacity: 0.7;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
    .unread-messages {
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      color: var(--tg-theme-button-color, #2481cc);
      font-size: 13px;
      padding: 4px 12px;
      border-radius: 12px;
      margin: 8px auto;
      text-align: center;
      width: fit-content;
    }

    /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –ø–æ–ª–Ω–æ–º —ç–∫—Ä–∞–Ω–µ */
    body {
      height: 100vh;
      height: -webkit-fill-available;
      padding-top: env(safe-area-inset-top);
      background: var(--tg-theme-bg-color, #fff);
    }

    #mainWrapper {
      height: 100%;
      padding-top: 0;
      display: flex;
      flex-direction: column;
    }

    /* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å —Ö–µ–¥–µ—Ä–æ–º Telegram */
    #chatContainer, #profileForm {
      padding-top: 0;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="mainWrapper">
    <!-- Profile Form -->
    <div id="profileForm">
      <h3>–ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç</h3>

      <span class="label">–ù–∏–∫–Ω–µ–π–º</span>
      <input
        type="text"
        id="nickname"
        placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º"
        autocomplete="off"
        autocorrect="off"
        spellcheck="false"
      />

      <span class="label">–ü–æ–ª</span>
      <div id="genderButtons">
        <button class="gender-btn" data-value="m">–ú—É–∂—Å–∫–æ–π</button>
        <button class="gender-btn" data-value="f">–ñ–µ–Ω—Å–∫–∏–π</button>
      </div>

      <span class="label">–í–æ–∑—Ä–∞—Å—Ç</span>
      <input
        id="age"
        type="number"
        placeholder="–£–∫–∞–∂–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç"
        inputmode="numeric"
        pattern="[0-9]*"
      />

      <span class="label">–ò–Ω—Ç–µ—Ä–µ—Å—ã</span>
      <div id="interestsContainer">
        <button class="interest-btn" data-value="–û–±—â–µ–Ω–∏–µ">–û–±—â–µ–Ω–∏–µ</button>
        <button class="interest-btn" data-value="–ó–Ω–∞–∫–æ–º—Å—Ç–≤–∞">–ó–Ω–∞–∫–æ–º—Å—Ç–≤–∞</button>
        <button class="interest-btn" data-value="–î—Ä—É–∂–±–∞">–î—Ä—É–∂–±–∞</button>
        <button class="interest-btn" data-value="–ò–≥—Ä—ã">–ò–≥—Ä—ã</button>
        <button class="interest-btn" data-value="–ú—É–∑—ã–∫–∞">–ú—É–∑—ã–∫–∞</button>
        <button class="interest-btn" data-value="–°–ø–æ—Ä—Ç">–°–ø–æ—Ä—Ç</button>
      </div>

      <button id="saveProfileBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫
      </button>
    </div>

    <!-- Chat -->
    <div id="chatContainer">
      <div id="partnerInfo">
        <span id="partnerLabel">–ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</span>
        <button id="skipBtn">–°–ª–µ–¥—É—é—â–∏–π</button>
      </div>
      <div id="chat">
        <div class="system-message chat-msg">–ò—â–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</div>
      </div>
      <div id="inputArea">
        <textarea id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" rows="1"></textarea>
        <button id="sendBtn">
          <svg viewBox="0 0 24 24">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    const socket = io();

    const mainWrapper = document.getElementById('mainWrapper');
    const profileForm = document.getElementById('profileForm');
    const nicknameInput = document.getElementById('nickname');
    const genderButtons = document.querySelectorAll('.gender-btn');
    let selectedGender = null;

    const ageInput = document.getElementById('age');
    const interestsContainer = document.getElementById('interestsContainer');
    const saveProfileBtn = document.getElementById('saveProfileBtn');

    const chatContainer = document.getElementById('chatContainer');
    const chat = document.getElementById('chat');
    const partnerLabel = document.getElementById('partnerLabel');
    const skipBtn = document.getElementById('skipBtn');

    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    let partnerId = null;
    let selectedInterests = new Set();

    // Gender selection
    genderButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        genderButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedGender = btn.dataset.value;
      });
    });

    // Interests selection
    interestsContainer.addEventListener('click', (e) => {
      const btn = e.target.closest('.interest-btn');
      if (btn) {
        const val = btn.dataset.value;
        if (selectedInterests.has(val)) {
          selectedInterests.delete(val);
          btn.classList.remove('active');
        } else {
          selectedInterests.add(val);
          btn.classList.add('active');
        }
      }
    });

    // Start button
    saveProfileBtn.addEventListener('click', () => {
      const nickname = nicknameInput.value.trim();
      const gender = selectedGender;
      const age = ageInput.value.trim();

      if (!/^[A-Za-z–ê-–Ø–∞-—è\s]{2,20}$/.test(nickname)) {
        tg.showAlert('–ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç 2 –¥–æ 20 –±—É–∫–≤');
        return;
      }
      if (!/^\d{1,2}$/.test(age) || age < 18 || age > 99) {
        tg.showAlert('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç (18-99)');
        return;
      }
      if (!gender) {
        tg.showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª');
        return;
      }
      if (selectedInterests.size === 0) {
        tg.showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä–µ—Å');
        return;
      }

      const interestsArray = Array.from(selectedInterests);

      socket.emit('setProfile', {
        nickname,
        gender,
        age,
        interests: interestsArray
      });

      profileForm.style.display = 'none';
      chatContainer.style.display = 'flex';
      addSystemMessage('üîé –ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–Ω–∞–∑–∞–¥"
      tg.BackButton.show();

      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
      tg.setHeaderColor(tg.colorScheme === 'dark' ? '#000000' : '#ffffff');
    });

    // Chat ready
    socket.on('chatReady', (data) => {
      partnerId = data.partnerId;
      const p = data.partnerProfile;
      const genderEmoji = p.gender === 'm' ? 'üë®' : 'üë©';
      partnerLabel.innerHTML = `
        <span class="online-indicator"></span>
        ${genderEmoji} ${p.nickname}, ${p.age}
      `;
      addSystemMessage('‚ú® –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω');
      messageInput.focus();
    });

    // Receive message
    socket.on('receiveMessage', (msg) => {
      addPartnerMessage(msg.text);
    });

    // Partner left
    socket.on('partnerLeft', () => {
      const onlineIndicator = document.querySelector('.online-indicator');
      if (onlineIndicator) {
        onlineIndicator.style.background = '#999';
      }
      addSystemMessage('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç');
      partnerLabel.innerText = '–ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...';
      partnerId = null;
    });

    // Send message
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });

    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !partnerId) return;
      
      socket.emit('sendMessage', text);
      addMyMessage(text);
      messageInput.value = '';
      
      if (window.innerWidth > 768) {
        messageInput.focus();
      }
    }

    // Desktop auto-focus
    if (window.innerWidth > 768) {
      chat.addEventListener('click', () => {
        messageInput.focus();
      });
    }

    // Mobile keyboard handling
    messageInput.addEventListener('focus', () => {
      if (window.innerWidth <= 768) {
        setTimeout(() => {
          chat.scrollTop = chat.scrollHeight;
        }, 300);
      }
    });

    // Window resize handling
    window.addEventListener('resize', () => {
      if (window.innerWidth <= 768) {
        chat.scrollTop = chat.scrollHeight;
      }
    });

    // Message utilities
    function addMyMessage(text) {
      const div = document.createElement('div');
      div.className = 'my-message chat-msg';
      div.innerText = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function addPartnerMessage(text) {
      const div = document.createElement('div');
      div.className = 'partner-message chat-msg';
      div.innerText = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function addSystemMessage(text) {
      const div = document.createElement('div');
      div.className = 'system-message chat-msg';
      div.innerHTML = `
        <span class="system-message-text">${text}</span>
      `;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –ø—É—Å—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏ —á–∞—Ç–∞
    chat.addEventListener('click', (e) => {
      if (e.target === chat) {
        messageInput.blur();
      }
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –≤–≤–æ–¥–∞
    function setupMobileInput() {
      const inputArea = document.getElementById('inputArea');
      const chat = document.getElementById('chat');
      let keyboardVisible = false;

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
      function updateTextareaHeight() {
        messageInput.style.height = 'auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
      messageInput.addEventListener('input', updateTextareaHeight);

      if (window.visualViewport) {
        let lastVisualViewportHeight = window.visualViewport.height;

        window.visualViewport.addEventListener('resize', () => {
          const currentHeight = window.visualViewport.height;
          const heightDiff = window.innerHeight - currentHeight;
          
          if (heightDiff > 150) { // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –æ—Ç–∫—Ä—ã—Ç–∞
            keyboardVisible = true;
            inputArea.style.position = 'absolute';
            inputArea.style.bottom = `${heightDiff}px`;
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            requestAnimationFrame(() => {
              chat.scrollTop = chat.scrollHeight;
            });
          } else {
            keyboardVisible = false;
            inputArea.style.position = 'fixed';
            inputArea.style.bottom = '0';
          }

          lastVisualViewportHeight = currentHeight;
        });

        window.visualViewport.addEventListener('scroll', () => {
          if (keyboardVisible) {
            inputArea.style.bottom = `${window.visualViewport.offsetTop}px`;
          }
        });
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (messageInput.value.trim()) {
            handleSend();
          }
        }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏
      function handleSend() {
        const text = messageInput.value.trim();
        if (!text || !partnerId) return;
        
        socket.emit('sendMessage', text);
        addMyMessage(text);
        
        messageInput.value = '';
        messageInput.style.height = '36px'; // –°–±—Ä–æ—Å –≤—ã—Å–æ—Ç—ã
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ–∫—É—Å –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
        if (keyboardVisible) {
          messageInput.focus();
        }
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —á–∞—Ç—É
      chat.addEventListener('click', (e) => {
        if (e.target === chat) {
          messageInput.blur();
        }
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', setupMobileInput);

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    window.addEventListener('resize', () => {
      if (window.innerWidth <= 768) {
        chat.scrollTop = chat.scrollHeight;
      }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–Ω–æ–ø–∫–∏ "–Ω–∞–∑–∞–¥"
    tg.BackButton.show();
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–Ω–∞–∑–∞–¥"
    tg.BackButton.onClick(() => {
      if (chatContainer.style.display === 'flex') {
        // –ï—Å–ª–∏ –º—ã –≤ —á–∞—Ç–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ø—Ä–æ—Ñ–∏–ª—é
        chatContainer.style.display = 'none';
        profileForm.style.display = 'block';
        
        // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
        if (partnerId) {
          socket.emit('leaveChat');
          partnerId = null;
        }
        
        // –û—á–∏—â–∞–µ–º —á–∞—Ç
        chat.innerHTML = '';
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        messageInput.value = '';

        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–Ω–∞–∑–∞–¥" –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
        tg.BackButton.hide();
      } else {
        // –ï—Å–ª–∏ –º—ã –≤ –ø—Ä–æ—Ñ–∏–ª–µ, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –æ –∑–∞–∫—Ä—ã—Ç–∏–∏
        if (confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
          tg.close();
        }
      }
    });

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
    function addMessage(text, isOwn) {
      const div = document.createElement('div');
      div.className = isOwn ? 'my-message chat-msg' : 'partner-message chat-msg';
      
      // –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç
      const messageText = document.createElement('div');
      messageText.className = 'message-text';
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏ –∏ —ç–º–æ–¥–∑–∏
      const formattedText = text
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: inherit; text-decoration: underline;">$1</a>')
        .replace(/\n/g, '<br>');
        
      messageText.innerHTML = formattedText;
      div.appendChild(messageText);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è
      const timeDiv = document.createElement('div');
      timeDiv.className = 'message-time';
      timeDiv.textContent = formatTime(new Date());
      div.appendChild(timeDiv);
      
      chat.appendChild(div);
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –±–ª–∏–∑–∫–æ –∫ –∫–æ–Ω—Ü—É
      if (chat.scrollHeight - chat.scrollTop - chat.clientHeight < 150) {
        chat.scrollTop = chat.scrollHeight;
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    messageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      const newHeight = Math.min(this.scrollHeight, 100);
      this.style.height = newHeight + 'px';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø —á–∞—Ç–∞
      chat.style.paddingBottom = (newHeight + 20) + 'px';
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Mini App
    document.addEventListener('DOMContentLoaded', () => {
      // –°–æ–æ–±—â–∞–µ–º —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
      tg.ready();
      
      // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
      tg.expand();
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Ö–µ–¥–µ—Ä–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç–µ–º–æ–π
      tg.setHeaderColor(tg.colorScheme === 'dark' ? '#000000' : '#ffffff');
      
      // –í–∫–ª—é—á–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è
      tg.enableClosingConfirmation();

      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–Ω–∞–∑–∞–¥"
      tg.BackButton.onClick(() => {
        if (chatContainer.style.display === 'flex') {
          // –ï—Å–ª–∏ –º—ã –≤ —á–∞—Ç–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ø—Ä–æ—Ñ–∏–ª—é
          chatContainer.style.display = 'none';
          profileForm.style.display = 'block';
          
          if (partnerId) {
            socket.emit('leaveChat');
            partnerId = null;
          }
          
          chat.innerHTML = '';
          messageInput.value = '';
          
          // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–Ω–∞–∑–∞–¥" –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
          tg.BackButton.hide();
        } else {
          // –ï—Å–ª–∏ –º—ã –≤ –ø—Ä–æ—Ñ–∏–ª–µ, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –æ –∑–∞–∫—Ä—ã—Ç–∏–∏
          if (confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            tg.close();
          }
        }
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
      const isDarkTheme = tg.colorScheme === 'dark';
      if (isDarkTheme) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }

      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ö—ç–ø–ø–∏-–ø–∞—Å —ç—Ñ—Ñ–µ–∫—Ç (–ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ)
      tg.onEvent('viewportChanged', () => {
        if (window.innerHeight === tg.viewportHeight) {
          document.body.classList.add('app-ready');
        }
      });

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
      setupMobileInput();
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      const isDark = e.matches;
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
      tg.setHeaderColor(isDark ? '#000000' : '#ffffff');
    });

    function setupInputArea() {
      const inputArea = document.getElementById('inputArea');
      const messageInput = document.getElementById('messageInput');
      const chat = document.getElementById('chat');
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
      function updateTextareaHeight() {
        messageInput.style.height = '36px';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ viewport (–¥–ª—è iOS)
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
          const currentHeight = window.visualViewport.height;
          const offset = window.innerHeight - currentHeight;
          
          if (offset > 0) {
            // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –æ—Ç–∫—Ä—ã—Ç–∞
            inputArea.style.position = 'absolute';
            inputArea.style.bottom = offset + 'px';
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            setTimeout(() => {
              chat.scrollTop = chat.scrollHeight;
            }, 100);
          } else {
            // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∑–∞–∫—Ä—ã—Ç–∞
            inputArea.style.position = 'fixed';
            inputArea.style.bottom = '0';
          }
        });

        window.visualViewport.addEventListener('scroll', () => {
          if (window.visualViewport.height < window.innerHeight) {
            inputArea.style.bottom = window.visualViewport.offsetTop + 'px';
          }
        });
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
      messageInput.addEventListener('input', updateTextareaHeight);
      
      messageInput.addEventListener('focus', () => {
        setTimeout(() => {
          chat.scrollTop = chat.scrollHeight;
        }, 100);
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —á–∞—Ç—É –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
      chat.addEventListener('click', (e) => {
        if (e.target === chat) {
          messageInput.blur();
        }
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (messageInput.value.trim()) {
            handleSend();
          }
        }
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
      setupInputArea();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();
    });
  </script>
</body>
</html>
